{% extends "main.html" %}
{% block head %}
    <link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/handsontable/8.3.2/handsontable.full.min.css">
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/handsontable/8.3.2/handsontable.full.min.js"></script>
<style>
.circle {
    display: inline-block;
    background-color: white; /* 背景颜色 */
    color: #4acbf5; /* 文字颜色 */
    font-size: 12px; /* 字体大小 */
    text-align: center; /* 文本居中 */
    height: 15px; /* 高度 */
    line-height: 15px; /* 行高，确保文本垂直居中 */
    cursor: pointer; /* 鼠标悬停时显示为指针 */
    margin-left: 2px;
}
</style>
{% endblock %}
{% block content %}
<div id="page-title">
    <h1 class="page-header text-overflow">Static Tables</h1>

    <!--Searchbox-->
    <div class="searchbox">
        <div class="input-group custom-search-form">
            <input type="text" class="form-control" placeholder="Search..">
            <span class="input-group-btn">
                <button class="text-muted" type="button"><i class="demo-pli-magnifi-glass"></i></button>
            </span>
        </div>
    </div>
</div>

<ol class="breadcrumb">
    <li><a href="#">Home</a></li>
    <li><a href="#">Tables</a></li>
    <li class="active">Static Tables</li>
</ol>
<div id="page-content">
    <div class="panel">
        <div>
            <button id="addBtn" class="btn btn-primary">
                <i class="ion-plus"></i> 添加
            </button>
        </div>
        <div id="table-container"></div>
    </div>
</div>
<script>
    $(document).ready(function () {

        var rows = 5; // 假设有5行
        var columns = 7; // 假设有5列
        var array2D = [];
        var sourceData = {{list|tojson}}

        $('#addBtn').click(function (){
            $.ajax({
             type: 'POST',
             url: '/api/v2/keyboard',
             contentType: 'application/json',
             data: JSON.stringify(array2D),
             dataType: 'json',
             success: function (data) {

             },
             error: function (err) {
                 console.log(err)
             }
         })
        })

        // 初始化空的二维数组，所有单元格设为空
        for (var i = 0; i < rows; i++) {
            array2D[i] = [];
            for (var j = 0; j < columns; j++) {
                array2D[i][j] = ''; // 空单元格
            }
        }

        const container = document.getElementById('table-container');


        function renderTable() {
            $('#table-container').empty()
            const hot = new Handsontable(container, {
                data: array2D,
                colHeaders(index) {
                    return `${index + 1}`;
                },
                rowHeaders: true,
                contextMenu: {
                    items: {
                        "row_below": { name: '插入下方行' },
                        "remove_row": { name: '删除行' },
                        "col_right": { name: '插入右侧列' },
                        "remove_col": { name: '删除列' },
                        "make_read_only": { name: '设为只读' },
                        "copy": { name: '复制' },
                        "cut": { name: '剪切' },
                        "paste": { name: '粘贴' },
                        "undo": { name: '撤销' },
                        "redo": { name: '重做' },
                    }
                },
                manualRowMove: false,
                manualColumnMove: false,
                licenseKey: 'non-commercial-and-evaluation', // 添加许可证密钥
                colWidths: 100,
                rowHeights: 30,
                height: 800,
                cells: function (row, col, prop) {
                    var cellProperties = {};
                    cellProperties.type = 'autocomplete';
                    cellProperties.source = function (query, process) {
                        console.log(query.toLowerCase())
                        var matches = sourceData.filter(function (item) {
                            return item.toLowerCase().includes(query.toLowerCase());
                        });
                        console.log(matches)
                        process(matches);
                    }
                    cellProperties.renderer = function (instance, td, row, col, prop, value, cellProperties){
                        td.style.textAlign = 'center'; // 水平居中
                        td.style.verticalAlign = 'middle'; // 垂直居中
                        if (value !== '') {
                            td.innerHTML = value + '<span class="delete-btn circle">删除</span>'
                        }

                        $(td).find('.delete-btn').on('click', function (e) {
                            array2D[row][col] = ''; // 清空单元格内容
                            renderTable(); // 重新渲染表格
                        });
                    };
                    return cellProperties;
                },
            });
        }
        renderTable();
    })
</script>
{% endblock %}